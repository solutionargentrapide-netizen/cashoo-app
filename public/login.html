// api/auth/login.js - VERSION CORRIGÉE ET SIMPLIFIÉE
const { createClient } = require('@supabase/supabase-js');
const jwt = require('jsonwebtoken');

module.exports = async (req, res) => {
  // Configuration Supabase
  const supabase = createClient(
    process.env.SUPABASE_URL || 'https://tvfqfjfkmccyrpfkkfva.supabase.co',
    process.env.SUPABASE_SERVICE_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2ZnFmamZrbWNjeXJwZmtrZnZhIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1ODczOTg3MywiZXhwIjoyMDc0MzE1ODczfQ.z7W1bIukn4ea3JmQwSjRu1oSIGjQX_2qQduGlUoXDZk'
  );

  // CORS pour tout accepter
  res.setHeader('Access-Control-Allow-Credentials', true);
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT');
  res.setHeader('Access-Control-Allow-Headers', 'X-Requested-With, X-HTTP-Method-Override, Content-Type, Accept, Authorization');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { email, password } = req.body;
    
    // Validation basique
    if (!email) {
      return res.status(400).json({ 
        success: false,
        error: 'Email requis' 
      });
    }

    const normalizedEmail = email.toLowerCase().trim();
    console.log('[LOGIN] Tentative pour:', normalizedEmail);

    // 1. Vérifier si l'utilisateur existe
    let { data: user, error: fetchError } = await supabase
      .from('users')
      .select('*')
      .eq('email', normalizedEmail)
      .single();

    // Si l'utilisateur n'existe pas, le créer automatiquement
    if (!user || fetchError) {
      console.log('[LOGIN] Utilisateur non trouvé, création automatique...');
      
      // Créer un nouvel utilisateur
      const newUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
      
      const { data: newUser, error: createError } = await supabase
        .from('users')
        .insert({
          id: newUserId,
          email: normalizedEmail,
          password_hash: null, // Pas de mot de passe requis
          email_verified: true, // Auto-vérifié
          created_at: new Date().toISOString(),
          last_login: new Date().toISOString()
        })
        .select()
        .single();

      if (createError) {
        console.error('[LOGIN] Erreur création:', createError);
        return res.status(500).json({ 
          success: false,
          error: 'Erreur de création de compte',
          details: createError.message
        });
      }

      user = newUser;
      console.log('[LOGIN] Utilisateur créé avec succès:', user.id);
    }

    // 2. Mettre à jour la dernière connexion
    await supabase
      .from('users')
      .update({ 
        last_login: new Date().toISOString(),
        failed_login_attempts: 0
      })
      .eq('id', user.id);

    // 3. Créer le token JWT
    const token = jwt.sign(
      { 
        userId: user.id, 
        email: user.email,
        emailVerified: true
      },
      process.env.JWT_SECRET || 'cashoo-jwt-secret-change-this-in-production-minimum-32-characters-long',
      { expiresIn: '30d' } // Token valide 30 jours
    );

    // 4. Créer la session
    const expiresAt = new Date();
    expiresAt.setDate(expiresAt.getDate() + 30);

    // Nettoyer les anciennes sessions
    await supabase
      .from('sessions')
      .delete()
      .eq('user_id', user.id);

    // Créer nouvelle session
    await supabase
      .from('sessions')
      .insert({
        user_id: user.id,
        token: token,
        expires_at: expiresAt.toISOString(),
        created_at: new Date().toISOString()
      });

    console.log('[LOGIN] Connexion réussie pour:', user.email);

    // 5. Retourner le succès
    return res.json({
      success: true,
      token: token,
      user: { 
        id: user.id, 
        email: user.email,
        emailVerified: true
      },
      message: user.created_at === user.last_login ? 'Compte créé et connecté!' : 'Connexion réussie!'
    });

  } catch (error) {
    console.error('[LOGIN] Erreur générale:', error);
    
    // Toujours retourner une réponse valide
    return res.status(200).json({ 
      success: false,
      error: 'Erreur de connexion. Veuillez réessayer.',
      details: process.env.NODE_ENV !== 'production' ? error.message : undefined
    });
  }
};
