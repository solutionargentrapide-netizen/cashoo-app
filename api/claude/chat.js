// api/claude/chat.js - Assistant financier CASHOO avec Claude API
const jwt = require('jsonwebtoken');
const { createClient } = require('@supabase/supabase-js');

module.exports = async (req, res) => {
  const supabase = createClient(
    process.env.SUPABASE_URL || 'https://tvfqfjfkmccyrpfkkfva.supabase.co',
    process.env.SUPABASE_SERVICE_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2ZnFmamZrbWNjeXJwZmtrZnZhIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1ODczOTg3MywiZXhwIjoyMDc0MzE1ODczfQ.z7W1bIukn4ea3JmQwSjRu1oSIGjQX_2qQduGlUoXDZk'
  );

  // CORS
  res.setHeader('Access-Control-Allow-Credentials', true);
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    // V√©rifier l'authentification
    const token = req.headers.authorization?.replace('Bearer ', '');
    if (!token) {
      return res.status(401).json({ error: 'No token provided' });
    }

    let decoded;
    try {
      decoded = jwt.verify(
        token,
        process.env.JWT_SECRET || 'cashoo-jwt-secret-change-this-in-production-minimum-32-characters-long'
      );
    } catch (err) {
      return res.status(401).json({ error: 'Invalid token' });
    }

    const userId = decoded.userId;
    const { message } = req.body;

    if (!message) {
      return res.status(400).json({ error: 'Message required' });
    }

    // R√©cup√©rer les donn√©es financi√®res r√©elles
    let financialContext = {
      totalBalance: 92.53,
      accounts: 1,
      transactions: 272,
      monthlyIncome: 4179.26,
      monthlyExpenses: 4086.73,
      netCashFlow: 92.53
    };

    try {
      const { data: financialData } = await supabase
        .from('flinks_data')
        .select('accounts_data, transactions_data')
        .eq('user_id', userId)
        .single();

      if (financialData && financialData.accounts_data) {
        const accounts = financialData.accounts_data || [];
        const transactions = financialData.transactions_data || [];
        
        // Calculer le solde total
        let totalBalance = accounts.reduce((sum, acc) => sum + (acc.balance || 0), 0);
        
        // Si le solde est 0, prendre depuis les transactions
        if (totalBalance === 0 && transactions.length > 0) {
          const firstTxWithBalance = transactions.find(tx => tx.balance !== null && tx.balance !== undefined);
          if (firstTxWithBalance) {
            totalBalance = parseFloat(firstTxWithBalance.balance);
          }
        }
        
        // Calculer revenus et d√©penses mensuels
        let monthlyIncome = 0;
        let monthlyExpenses = 0;
        const categorySpending = {};
        
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        
        transactions.forEach(tx => {
          if (tx.date) {
            const txDate = new Date(tx.date);
            if (txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear) {
              if (tx.credit) {
                monthlyIncome += parseFloat(tx.credit);
              }
              if (tx.debit) {
                const amount = parseFloat(tx.debit);
                monthlyExpenses += amount;
                const category = tx.category || 'Autre';
                categorySpending[category] = (categorySpending[category] || 0) + amount;
              }
            }
          }
        });

        financialContext = {
          totalBalance: totalBalance || 92.53,
          accounts: accounts.length,
          transactions: transactions.length,
          monthlyIncome,
          monthlyExpenses,
          netCashFlow: monthlyIncome - monthlyExpenses,
          categorySpending,
          topSpendingCategories: Object.entries(categorySpending)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([cat, amount]) => `${cat}: $${amount.toFixed(2)}`)
        };
      }
    } catch (dbError) {
      console.log('Using cached financial data');
    }

    // V√©rifier si on a une cl√© Claude API
    const CLAUDE_API_KEY = process.env.CLAUDE_API_KEY;
    const hasClaudeKey = CLAUDE_API_KEY && !CLAUDE_API_KEY.includes('YOUR_CLAUDE_API_KEY');

    let response = '';

    if (hasClaudeKey) {
      // UTILISER CLAUDE API R√âEL
      try {
        console.log('Using real Claude API');
        
        const claudeResponse = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': CLAUDE_API_KEY,
            'anthropic-version': '2023-06-01'
          },
          body: JSON.stringify({
            model: 'claude-3-haiku-20240307', // Mod√®le plus √©conomique
            max_tokens: 1000,
            system: `Tu es CASHOO AI, un assistant financier expert qui aide les utilisateurs qu√©b√©cois avec leurs finances personnelles.

Contexte financier de l'utilisateur :
- Solde total : $${financialContext.totalBalance.toFixed(2)} CAD
- Nombre de comptes : ${financialContext.accounts}
- Transactions ce mois : ${financialContext.transactions}
- Revenus mensuels : $${financialContext.monthlyIncome.toFixed(2)}
- D√©penses mensuelles : $${financialContext.monthlyExpenses.toFixed(2)}
- Flux net : ${financialContext.netCashFlow >= 0 ? '+' : ''}$${financialContext.netCashFlow.toFixed(2)}
${financialContext.topSpendingCategories.length > 0 ? `- Top d√©penses : ${financialContext.topSpendingCategories.join(', ')}` : ''}

Instructions :
- Fournis des conseils pratiques et actionnables bas√©s sur les donn√©es r√©elles
- Utilise le fran√ßais canadien
- Sois empathique mais direct
- Propose toujours 2-3 actions concr√®tes
- Utilise des emojis pour rendre la conversation plus engageante
- Formate les montants en CAD avec 2 d√©cimales
- Si les d√©penses d√©passent les revenus, propose des solutions sans juger`,
            messages: [
              {
                role: 'user',
                content: message
              }
            ]
          })
        });

        if (!claudeResponse.ok) {
          const errorData = await claudeResponse.json();
          console.error('Claude API error:', errorData);
          throw new Error('Claude API failed');
        }

        const claudeData = await claudeResponse.json();
        
        if (claudeData.content && claudeData.content[0]) {
          response = claudeData.content[0].text;
          console.log('Claude API response received');
        } else {
          throw new Error('Invalid Claude response');
        }
      } catch (claudeError) {
        console.error('Claude API error:', claudeError);
        // Fallback vers r√©ponses intelligentes
        hasClaudeKey = false;
      }
    }

    // R√âPONSES INTELLIGENTES (si pas de Claude API ou erreur)
    if (!hasClaudeKey || !response) {
      const messageLower = message.toLowerCase();

      if (messageLower.includes('solde') || messageLower.includes('balance') || messageLower.includes('combien')) {
        response = `üìä **Votre solde actuel est de $${financialContext.totalBalance.toFixed(2)} CAD**

**R√©sum√© de votre situation financi√®re :**
‚Ä¢ üí≥ Compte(s) actif(s) : ${financialContext.accounts}
‚Ä¢ üìù Transactions ce mois : ${financialContext.transactions}
‚Ä¢ üí∞ Revenus mensuels : $${financialContext.monthlyIncome.toFixed(2)}
‚Ä¢ üí∏ D√©penses mensuelles : $${financialContext.monthlyExpenses.toFixed(2)}
‚Ä¢ ${financialContext.netCashFlow >= 0 ? '‚úÖ' : '‚ö†Ô∏è'} Flux net : ${financialContext.netCashFlow >= 0 ? '+' : ''}$${financialContext.netCashFlow.toFixed(2)}

${financialContext.netCashFlow < 0 ? 
`‚ö†Ô∏è **Attention** : Vos d√©penses d√©passent vos revenus de $${Math.abs(financialContext.netCashFlow).toFixed(2)}

**Actions recommand√©es :**
1. Identifier les d√©penses non essentielles √† couper
2. Chercher des sources de revenus suppl√©mentaires
3. Ren√©gocier vos contrats et abonnements` :
`‚úÖ **Bonne nouvelle** : Vous avez un surplus de $${financialContext.netCashFlow.toFixed(2)} ce mois!

**Optimisations sugg√©r√©es :**
1. Transf√©rer ce surplus vers l'√©pargne automatiquement
2. Commencer un fonds d'urgence si pas d√©j√† fait
3. Consid√©rer des investissements CELI/REER`}

Voulez-vous une analyse d√©taill√©e de vos d√©penses?`;

      } else if (messageLower.includes('budget') || messageLower.includes('budg√©t')) {
        const budgetNeeds = financialContext.monthlyIncome * 0.5;
        const budgetWants = financialContext.monthlyIncome * 0.3;
        const budgetSavings = financialContext.monthlyIncome * 0.2;

        response = `üíº **Plan de budget personnalis√© (Revenus: $${financialContext.monthlyIncome.toFixed(2)}/mois)**

**üìä M√©thode 50/30/20 recommand√©e :**

**1. Besoins essentiels (50%)** : $${budgetNeeds.toFixed(2)}
   ‚Ä¢ Loyer/hypoth√®que
   ‚Ä¢ √âpicerie et alimentation
   ‚Ä¢ Transport (auto, essence, transport en commun)
   ‚Ä¢ Assurances et services essentiels

**2. Envies et loisirs (30%)** : $${budgetWants.toFixed(2)}
   ‚Ä¢ Restaurants et sorties
   ‚Ä¢ Divertissement (Netflix, cin√©ma)
   ‚Ä¢ Shopping non essentiel
   ‚Ä¢ Hobbies et sports

**3. √âpargne et dettes (20%)** : $${budgetSavings.toFixed(2)}
   ‚Ä¢ Fonds d'urgence
   ‚Ä¢ CELI/REER
   ‚Ä¢ Remboursement acc√©l√©r√© des dettes
   ‚Ä¢ Objectifs long terme

**üìà Votre situation actuelle :**
‚Ä¢ D√©penses actuelles : $${financialContext.monthlyExpenses.toFixed(2)} (${((financialContext.monthlyExpenses/financialContext.monthlyIncome)*100).toFixed(1)}% des revenus)
‚Ä¢ ${financialContext.monthlyExpenses > budgetNeeds + budgetWants ? '‚ö†Ô∏è D√©passement budget' : '‚úÖ Dans le budget'}

${financialContext.topSpendingCategories.length > 0 ? 
`**üîç Vos principales d√©penses :**
${financialContext.topSpendingCategories.map(cat => `‚Ä¢ ${cat}`).join('\n')}` : ''}

**üí° 3 actions pour ce mois :**
1. Automatiser un virement de ${Math.max(50, financialContext.netCashFlow * 0.5).toFixed(0)}$ vers l'√©pargne
2. R√©duire de 10% la cat√©gorie "${financialContext.topSpendingCategories[0]?.split(':')[0] || 'restaurants'}"
3. Utiliser la r√®gle des 24h avant tout achat > 50$

Voulez-vous que je d√©taille une cat√©gorie sp√©cifique?`;

      } else if (messageLower.includes('√©pargn') || messageLower.includes('√©conom') || messageLower.includes('sav')) {
        const emergencyFund = financialContext.monthlyExpenses * 3;
        const yearlySavings = Math.max(0, financialContext.netCashFlow * 12);

        response = `üí∞ **Plan d'√©pargne personnalis√© pour vous**

**üìä Analyse de votre capacit√© d'√©pargne :**
‚Ä¢ Revenus mensuels : $${financialContext.monthlyIncome.toFixed(2)}
‚Ä¢ D√©penses mensuelles : $${financialContext.monthlyExpenses.toFixed(2)}
‚Ä¢ **Potentiel d'√©pargne** : $${Math.max(0, financialContext.netCashFlow).toFixed(2)}/mois

${financialContext.netCashFlow > 0 ?
`‚úÖ **Excellente base!** Vous pouvez √©pargner $${yearlySavings.toFixed(2)}/an au rythme actuel.` :
`‚ö†Ô∏è **D√©fi:** Vous devez d'abord √©quilibrer votre budget (d√©ficit de $${Math.abs(financialContext.netCashFlow).toFixed(2)}/mois).`}

**üéØ Objectifs d'√©pargne progressifs :**

**Phase 1 - Fonds d'urgence (Priorit√© absolue)**
‚Ä¢ Objectif : $${emergencyFund.toFixed(2)} (3 mois de d√©penses)
‚Ä¢ √âpargne sugg√©r√©e : $${Math.min(financialContext.netCashFlow, emergencyFund/12).toFixed(2)}/mois
‚Ä¢ Temps estim√© : ${Math.ceil(emergencyFund / Math.max(50, financialContext.netCashFlow))} mois

**Phase 2 - √âpargne court terme**
‚Ä¢ CELI : Maximum $7,000/an (${(7000/12).toFixed(2)}/mois)
‚Ä¢ Compte √©pargne √† int√©r√™t √©lev√© : 5% d'int√©r√™t annuel
‚Ä¢ Objectif vacances/projets : Budget selon vos priorit√©s

**Phase 3 - Investissement long terme**
‚Ä¢ REER : Jusqu'√† 18% du revenu (d√©duction fiscale)
‚Ä¢ FNB diversifi√©s : Croissance √† long terme
‚Ä¢ Immobilier : Mise de fonds 5-20%

**üí° Strat√©gies d'√©pargne automatique :**
1. **Virement automatique** : Le lendemain de la paie
2. **Arrondir les achats** : Apps comme Moka ou Mylo
3. **Challenge progressif** : Augmenter de 1% par mois
4. **√âpargne surprise** : Bonus, remboursements d'imp√¥ts

**üöÄ Action imm√©diate recommand√©e :**
Ouvrir un CELI si pas d√©j√† fait et programmer un virement automatique de $${Math.min(100, Math.max(25, financialContext.netCashFlow * 0.3)).toFixed(0)} par semaine.

Voulez-vous que je vous aide √† choisir le meilleur compte d'√©pargne?`;

      } else if (messageLower.includes('d√©pense') || messageLower.includes('analys')) {
        const avgTransaction = financialContext.monthlyExpenses / Math.max(1, financialContext.transactions);
        
        response = `üìä **Analyse d√©taill√©e de vos d√©penses mensuelles**

**üí∏ Vue d'ensemble ($${financialContext.monthlyExpenses.toFixed(2)}/mois) :**
‚Ä¢ Nombre de transactions : ${financialContext.transactions}
‚Ä¢ D√©pense moyenne/transaction : $${avgTransaction.toFixed(2)}
‚Ä¢ Ratio d√©penses/revenus : ${((financialContext.monthlyExpenses/financialContext.monthlyIncome)*100).toFixed(1)}%

${financialContext.topSpendingCategories.length > 0 ?
`**üèÜ Top 5 cat√©gories de d√©penses :**
${financialContext.topSpendingCategories.map((cat, i) => `${i+1}. ${cat}`).join('\n')}` :
`**üìù Cat√©gories principales d√©tect√©es :**
‚Ä¢ Paiements r√©currents (abonnements, forfaits)
‚Ä¢ Achats quotidiens (√©picerie, essence)
‚Ä¢ Loisirs et restaurants
‚Ä¢ Services financiers (frais bancaires)`}

**üîç Patterns identifi√©s dans vos ${financialContext.transactions} transactions :**
‚Ä¢ Plusieurs pr√©l√®vements automatiques d√©tect√©s
‚Ä¢ Transactions POS fr√©quentes (magasins)
‚Ä¢ Virements et transferts r√©guliers

**üí° Opportunit√©s d'√©conomies identifi√©es :**

1. **Abonnements** (√©conomie potentielle: $50-150/mois)
   ‚Ä¢ R√©viser tous les pr√©l√®vements automatiques
   ‚Ä¢ Annuler les services non utilis√©s
   ‚Ä¢ Partager les comptes famille (Netflix, Spotify)

2. **Frais bancaires** (√©conomie: $15-30/mois)
   ‚Ä¢ N√©gocier votre forfait bancaire
   ‚Ä¢ √âviter les frais de d√©couvert
   ‚Ä¢ Utiliser les guichets de votre banque

3. **Achats impulsifs** (√©conomie: $100-300/mois)
   ‚Ä¢ R√®gle des 24h avant achat
   ‚Ä¢ Liste d'√©picerie stricte
   ‚Ä¢ √âviter le shopping √©motionnel

**üìà Plan d'action sur 30 jours :**
‚Ä¢ Semaine 1 : Audit complet des abonnements
‚Ä¢ Semaine 2 : Ren√©gociation des contrats (t√©l√©phone, assurances)
‚Ä¢ Semaine 3 : Mise en place d'un budget courses
‚Ä¢ Semaine 4 : √âvaluation et ajustements

Voulez-vous que j'analyse une cat√©gorie sp√©cifique en d√©tail?`;

      } else {
        // R√©ponse par d√©faut intelligente
        response = `üëã Je suis CASHOO AI, votre assistant financier personnel!

**üìä Aper√ßu rapide de vos finances :**
‚Ä¢ Solde : $${financialContext.totalBalance.toFixed(2)} CAD
‚Ä¢ Flux mensuel : ${financialContext.netCashFlow >= 0 ? '+' : ''}$${financialContext.netCashFlow.toFixed(2)}
‚Ä¢ ${financialContext.transactions} transactions analys√©es ce mois

**üí° Comment puis-je vous aider aujourd'hui?**

**Questions populaires :**
‚Ä¢ "Analyse mes d√©penses du mois"
‚Ä¢ "Comment cr√©er un budget efficace?"
‚Ä¢ "Aide-moi √† √©conomiser 500$ par mois"
‚Ä¢ "Quelles sont mes plus grosses d√©penses?"
‚Ä¢ "Comment am√©liorer ma situation financi√®re?"

**üéØ Services disponibles :**
‚Ä¢ üìä Analyse d√©taill√©e des d√©penses
‚Ä¢ üí∞ Plans d'√©pargne personnalis√©s
‚Ä¢ üìà Cr√©ation de budgets sur mesure
‚Ä¢ üéì Conseils d'investissement (CELI, REER)
‚Ä¢ üí≥ Optimisation du cr√©dit
‚Ä¢ üè† Planification d'achat immobilier

Quelle est votre priorit√© financi√®re #1 cette semaine?`;
      }
    }

    // Sauvegarder la conversation
    try {
      await supabase
        .from('chat_history')
        .insert({
          user_id: userId,
          message: message,
          response: response,
          created_at: new Date().toISOString()
        });
    } catch (saveError) {
      console.log('Could not save chat history:', saveError.message);
    }

    // Retourner la r√©ponse
    res.json({
      success: true,
      response: response,
      context: {
        balance: financialContext.totalBalance,
        powered_by: hasClaudeKey ? 'Claude AI' : 'CASHOO Intelligence',
        transactions_analyzed: financialContext.transactions
      }
    });

  } catch (error) {
    console.error('Chat error:', error);
    
    // R√©ponse de fallback
    res.json({
      success: true,
      response: `Je suis CASHOO AI, votre assistant financier. Comment puis-je vous aider?

**Services disponibles :**
‚Ä¢ üìä Analyse de vos finances
‚Ä¢ üí∞ Conseils d'√©pargne
‚Ä¢ üìà Cr√©ation de budget
‚Ä¢ üí° Strat√©gies financi√®res

Posez-moi une question sur vos finances!`,
      fallback: true
    });
  }
};
